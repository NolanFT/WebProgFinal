[phases.setup]
nixPkgs = ["php82", "composer", "nodejs_20"]

[phases.build]
cmds = [
  "composer install --no-dev --optimize-autoloader",
  "npm install",
  "npm run build"
]

[start]
cmd = "
until php -r \"new PDO('mysql:host='.getenv('DB_HOST').';port='.getenv('DB_PORT').';dbname='.getenv('DB_DATABASE'), getenv('DB_USERNAME'), getenv('DB_PASSWORD'))\" 2>/dev/null; do
  echo 'Waiting for database...'
  sleep 2
done
php artisan migrate:fresh --seed --force
php artisan serve --host=0.0.0.0 --port=$PORT
"


